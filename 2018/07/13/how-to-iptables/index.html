<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="">
    <link rel="stylesheet" href="https://cdn.rawgit.com/innks/NanumSquareRound/master/nanumsquareround.css"> 
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/nanumgothiccoding.css">
    <link rel="stylesheet" href="/css/style.css">

    

    
    <title>Iptables 일반사항 | sacoku&#39;s github.io</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="Linux,iptables" />
    
    <meta name="description" content="netfilter란? 커널에서 패킷을 필터링 하는 모듈. iptables 가 netfilter 커널 모듈을 이용하여 패킷을 필터링 한다. 즉, iptables를 이용하여 패킷 룰-셋을 구축하며 netfilter가 룰셋에 따라서 패킷을 필터링 등의 역활을 수행한다. iptables란   iptables에는 세가지 chain이 있고 모든 패킷은 이 세가지 ch">
<meta name="keywords" content="Linux,iptables">
<meta property="og:type" content="article">
<meta property="og:title" content="Iptables 일반사항">
<meta property="og:url" content="https://sacoku.github.io/2018/07/13/how-to-iptables/index.html">
<meta property="og:site_name" content="sacoku&#39;s github.io">
<meta property="og:description" content="netfilter란? 커널에서 패킷을 필터링 하는 모듈. iptables 가 netfilter 커널 모듈을 이용하여 패킷을 필터링 한다. 즉, iptables를 이용하여 패킷 룰-셋을 구축하며 netfilter가 룰셋에 따라서 패킷을 필터링 등의 역활을 수행한다. iptables란   iptables에는 세가지 chain이 있고 모든 패킷은 이 세가지 ch">
<meta property="og:locale" content="ko">
<meta property="og:image" content="https://www.famouslogos.us/images/linux-logo.jpg">
<meta property="og:updated_time" content="2018-07-13T08:30:08.794Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Iptables 일반사항">
<meta name="twitter:description" content="netfilter란? 커널에서 패킷을 필터링 하는 모듈. iptables 가 netfilter 커널 모듈을 이용하여 패킷을 필터링 한다. 즉, iptables를 이용하여 패킷 룰-셋을 구축하며 netfilter가 룰셋에 따라서 패킷을 필터링 등의 역활을 수행한다. iptables란   iptables에는 세가지 chain이 있고 모든 패킷은 이 세가지 ch">
<meta name="twitter:image" content="https://www.famouslogos.us/images/linux-logo.jpg">
    

    
        <link rel="alternate" href="/" title="sacoku&#39;s github.io" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">Develop History</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">홈</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Bigdata/">Bigdata</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Bigdata/Hadoop/">Hadoop</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Blog/">Blog</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Blog/2018/">2018</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/DevOps/">DevOps</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/DevOps/Docker/">Docker</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/DevOps/Git/">Git</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/DevOps/Linux/">Linux</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Deveop/">Deveop</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Deveop/Network/">Network</a></li></ul></li></ul>
                                    
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="검색" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '포스트',
            PAGES: 'Pages',
            CATEGORIES: '카테고리',
            TAGS: '태그',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/DevOps/">DevOps</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/categories/DevOps/Linux/">Linux</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-how-to-iptables" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Iptables 일반사항
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2018/07/13/how-to-iptables/" class="article-date">
            <time datetime="2018-07-13T08:00:11.000Z" itemprop="datePublished">2018-07-13</time>
        </a>
    </div>

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Linux/">Linux</a>, <a class="tag-link" href="/tags/iptables/">iptables</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <h2>netfilter란?</h2>
<p>커널에서 패킷을 필터링 하는 모듈. iptables 가 netfilter 커널 모듈을 이용하여 패킷을 필터링 한다. 즉, iptables를 이용하여 패킷 룰-셋을 구축하며 netfilter가 룰셋에 따라서 패킷을 필터링 등의 역활을 수행한다.</p>
<h2>iptables란</h2>
<ul>
<li>
<p>iptables에는 세가지 chain이 있고 모든 패킷은 이 세가지 chain중 하나를 통과하게 된다. 이 세가지 chain은 <code>INPUT, OUTPUT, FORWARD chain</code>인데 우선 여러분의 컴퓨터로 들어가는 모든 패킷은 <code>INPUT chain</code>을 통과한다. 그리고 여러분의 컴퓨터에서 나가는 모든 패킷은 <code>OUTPUT chain</code>을 통과한다. 그리고 하나의 네트워크에서 다른 곳으로 보내는 모든 패킷은 <code>FORWARD chain</code> 을 통과한다.</p>
</li>
<li>
<p>iptables가 작동하는 방식은 이들 각각의 <code>INPUT, OUTPUT, FORWARD chain</code>에 당신이 어떠한 rule을 세우는 지에 따라 달라진다. 예를 들어 당신이 HTML 페이지를 요청하기 위해 http://www.yahoo.com에 패킷을 보낸다면 이 패킷은 우선 당신 컴퓨터의 <code>OUTPUT chain</code>을 통과하게 된다. 그러면 kernel에서 <code>OUTPUT chain</code>의 rule을 확인하고 rule과 match가 되는지 확인을 하게 된다. rule중에서 최초로 match되는 것에 의해 당신이 보낸 패킷의 운명이 결정되는 것이다. 만약 어떤 rule과도 match되지 않는다면 전체 chain의 정책이 ACCEPT냐 DROP이냐에 따라 패킷의 운명이 결정될 것이다. 그러고 나서 Yahoo! 에서 응답하는 패킷은 당신의 <code>INPUT chain</code>을 통과하게 될 것이다</p>
</li>
<li>
<p>iptables로 할 수 있는 일에는 몇가지 다른 것이 있다. 첫번째 작동은 전체 체인을 조절한다. 처음 시작은 세개의 미리 만들어진 체인으로 시작하는 데 이것은 제거될 수 없다</p>
</li>
<li>
<p>iptables는 모듈로 되어있을 것이다. 이것은 <code>iptable_filter.o</code> 이다. 이것은 처음으로 iptables를 실행 할 때 자동으로 로드 될 것이다. 이것은 커널에 영구히 포함될 수도 있다</p>
</li>
<li>
<p>iptables 명령이 실행되기 전에는 기본적으로 만들어져 있는 체인 <code>INPUT, FORWARDING, OUTPUT chain</code>에는 아무런 규칙도 없다.</p>
</li>
</ul>
<h3>기본 Chain</h3>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&amp;nbsp------&gt;INPUT------&gt; Linux Box ------&gt;OUTPUT---------&gt;</span><br><span class="line"></span><br><span class="line">---------↕-----------------------------↕</span><br><span class="line"></span><br><span class="line">---------└---------- FORWARD ----------┘</span><br></pre></td></tr></table></figure></p>
<p>Linux box를 도착지로 삼는 모든 패킷은 <code>INPUT Chain</code>을 통과하게 되며 Linux box에서 생성되 외부로 보내지는 모든 패킷은 <code>OUTPUT Chain</code>을 통과하게 된다. <code>Forward chain</code>은 엄밀히 말하자면 도착지가 Linux box가 아닌 패킷이 통과하게 되는 체인이다</p>
<h3>Chain의 실행 순서와 사용자 Chain과의 관계</h3>
<p>iptables의 강력한 기능중의 하나는 사용자가 기존의 세개의 체인 <code>INPUT, OUTPUT, FORWARD chain</code>외에 새로운 체인을 생성할 수 있다는 것이다.</p>
<p>타겟이 사용자 지정의 체인인 규칙에 패킷이 맞으면 패킷은 사용자 지정의 체인을 따라 움직이게 된다. 그 체인이 패킷의 운명을 결정하지 못하면 그리고 그 체인에 따른 이송이 끝나면, 패킷은 현제 체인의 다음 규칙으로 돌아온다</p>
<p>이해를 위해 예를 들자면 아래의 그림은 두개의 체인이 있고 그것이 <code>INPUT</code> 과  <code>test</code> 라는 사용자 지정의 체인이 라고 가정해 보자</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">         `INPUT&apos;                         `test&apos; </span><br><span class="line">----------------------------    ----------------------------</span><br><span class="line">|  Rule1: -p ICMP -j DROP  |    |  Rule1: -s 192.168.1.1   |</span><br><span class="line">|--------------------------|    |--------------------------|</span><br><span class="line">|  Rule2: -p TCP -j test   |    |  Rule2: -d 192.168.1.1   |</span><br><span class="line">|--------------------------|    |--------------------------| </span><br><span class="line">|  Rule3: -p UDP -j DROP   |</span><br><span class="line">|--------------------------|</span><br></pre></td></tr></table></figure></p>
<p>192.168.1.1 로부터 와서 1.2.3.4 로 향하는 TCP 패킷이 있다고 가정해보자. 이것은 입력 체인으로 들어온다.</p>
<ol>
<li>Rule1 을 검사한다. =&gt; 맞지 않음</li>
<li>Rule2 맞음. 타겟은 &quot;test&quot;, 고로 다음 검사할 규칙은 &quot;test&quot; 의 시작이다</li>
<li>test의 Rule1 이 맞다. 그러나 이것이 타겟을 지정하지 않는다. 그러므로 다음 규칙이 검사된다</li>
<li>Rule 2. 맞지 않음.</li>
<li>체인의 끝에 도달.</li>
<li>다시 입력 체인으로 돌아가서 Rule3 을 검사 한다. 그것도 맞지 않음</li>
<li>그러므로 Drop 시켜 버림</li>
</ol>
<p>패킷의 이동경로를 그림으로 나타내보자</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">                              v    __________________________</span><br><span class="line"> `INPUT&apos;                |   /    `test&apos;                v</span><br><span class="line">------------------------|--/    -----------------------|----</span><br><span class="line">| Rule1                 | /|    | Rule1                |   |</span><br><span class="line">|-----------------------|/-|    |----------------------|---|</span><br><span class="line">| Rule2                 /  |    | Rule2                |   |</span><br><span class="line">|--------------------------|    -----------------------v----</span><br><span class="line">| Rule3                 /--+___________________________/</span><br><span class="line">------------------------|---</span><br><span class="line">                           v</span><br></pre></td></tr></table></figure></p>
<p>사용자 지정의 체인에서 대를 사용자 지정의 체인으로 갈수 있다. (그러나 루프를 돌 수는 없다. 루프를 발견하게 되면 패킷은 DROP  된다.</p>
<h3>Rule의 순서</h3>
<p>iptables의 chain에서는 먼저 등록 된 rule이 효력을 발생하기때문에 등록을 하는 순서가 중요하다. 모든 것을 거부하는 설정이 먼저 오게 되면 그 이후에 포트를 열어주는 설정이 와도 효과가 없다. 그러므로 허용하는 정책이 먼저 오고 나서 거부하는 정책이 와야  한다.</p>
<p>-A 옵션을 줌으로써 우리는 새로운 규칙을 chain의 맨 아래에 추가하게 된다. 즉 chain상의 상위 rule이 먼저 작동하기 때문에, 만일 새로 추가하는 rule을 먼저 작동시키기 위해서는 -I 옵션을 줌으로써 새로운 rule을 원하는 위치에 놓을 수 있다. 예를 들어 INPUT chain의 가장 위에 어떤 rule을 놓고 싶다면 “-I INPUT 1” 이라 명령하면 된다. 그리고 다른 위치로 놓고 싶다면 1을 다른 숫자로 바꿔주면  된다.</p>
<p>이미 위치된 rule을 다른 위치로 바꾸고 싶다면 -R 옵션을 주면 된다. -I 옵션을 주는 것과 마찬가지로 사용할 수 있는데 다만 -I옵션을 사용해서 1의 위치에 놓으면 다른 rule들이 밑으로 한 칸씩 내려가는 반면 -R옵션을 사용해서 1의 위치에 놓으면 그 위치의 rule은  삭제된다.</p>
<p>rule을 삭제하고 싶다면 -D옵션과 숫자를 사용하면 되고, -L 옵션을 사용하면 작성된 모든 rule의 목록을 보여주고, -F 옵션을 주면 해당 chain의 모든 rule을 삭제한다. 그리고 만약 chain을 명시하지 않았다면 모든 것을 flush할 것이다.</p>
<h2>iptables 예제</h2>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -s 200.200.200.1 -j DROP</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>200.200.200.1 이라는 source IP(-s)로부터 오는(INPUT) 모든 패킷을 막는(DROP) 규칙을 추가(A)한다.    -&gt; 이 한 줄의 명령으로 200.200.200.1로부터 오는 모든 패킷을 무시할 수 있다. 옵션의 순서는 바뀌어도 상관이 없다. 즉 -j DROP이 -s 200.200.200.1 보다 앞에 가도 상관이 없다. 만약 그 반대로 200.200.200.1로 패킷이 못가도록 하려면 INPUT 대신에 OUTPUT을, -s 대신에 -d(destination) 옵션을 주면된다</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp --sport 25 -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>25번이라는 source포트(--sport)에서 오는(INPUT) protocol이(-p) tcp인 모든 접속을 허락하는(ACCEPT) 규칙을 추가(A)한다.    -&gt; source port 와 destination port를 혼동하면 안된다. 즉 클라이언트는 어떤 포트로도 작동할 수 있는 반면에 서버는 23번 포트로 작동하기 때문이다. 즉 특정 서비스를 차단하기 위해서는 -destination-port를 이용하면 되고, 그 반대는 -source-port를 이용하면 된다.     -&gt; IP의 영역을 선택하고 싶다면 200.200.200.0/24 와 같이 설정하면 된다. 이것은 200.200.200.* 에 해당하는 모든 IP를 선택하는 것과 같다</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -s 200.200.200.1 -p tcp --destination-port telnet -j DROP</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>200.200.200.1 이라는 source IP(-s)로부터 오는(INPUT) protocol이(-p) tcp이고 목적지 port(--destination-port)가 telnet인 패킷의 접속을 막는(DROP) 규칙을 추가(A)한다</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -i eth1 -s 192.168.1.0/24 -d 0/0 -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>192.168.1.0/24라는 source IP(-s)로부터 오는(INPUT) 서버안으로 들어오는 인터페이스(-i)가 eth1이고 destination IP(-d)가 어떤 IP라도(0/0) 접속을 허락하는(ACCEPT) 규칙을 추가(A)한다. (서버자체에 대한 접속이 아니라 마스커레이딩등을 이용하여 랜카드 두 개를 장착한 경우 eth1에 연결된 내부 PC에서 외부로의 접속 허용)</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp --destination-port telnet -i ppp0 -j DROP</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>protocol이(-p) tcp이고 목적지 port(--destination-port)가 telnet이며, 서버안으로 들어오는 인터페이스(-i)가 ppp0인 패킷의 접속을 막는(DROP) 규칙을 추가(A)한다. 이렇게 함으로써 우리는 LAN상의 사용자는 telnet을 사용하고 그밖에 Internet상의 사용자는 telnet 을 사용하지 못하도록 할 수 있다</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -i ppp0 -p tcp --syn -j DROP</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>ppp0 로 들어오는 모든 tcp의 연결을 무시해버림. 두 컴퓨터가 TCP connection으로 패킷을 주고 받는다면 그 connection은 우선 초기화가 되어야 한다. 이것은 바로 SYN packet이 담당한다. SYN packet은 단순히 다른 컴퓨터에게 주고 받을 준비가 되었다는 것만 알려주는 초기화 기능만을 한다. 이제 서비스를 요청하는 컴퓨터는 우선적으로 SYN packet을 보낸다는 것을 알게 되었다. 그러므로 들어오는 SYN packet만 막기만 하면 다른 컴퓨터가 당신 컴퓨터의 서비스를 이용하지 못하게 할 수 있고, 하지만 당신은 그들과 통신할 수 있는 것이다. 즉 이와 같이 하면 당신이 먼저 패킷을 보내서 요청이 들어오는 것이 아니면 모두 무시해 버리게 된다</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -i ppp0 -p tcp --syn --destination-port ! 80 -j DROP</span><br></pre></td></tr></table></figure></p>
<p>80번 포트만 제외하고 모든 SYN packet들을 막는다. 만약 당신이 웹서비스를 위해 하나의 포트(예를들어 80번-HTTP)만 열어두고 싶다면 역시 한가지 방법이 있다. 바로 “!” 마크를 사용하면 되는데 많은 프로그래밍 언어에서처럼 “!”은 “not”을 의미한다. 예를들어 80번 포트만 제외하고 모든 SYN packet들을 막고싶다면 위와 같이하면된다</p>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p icmp --icmp-type <span class="built_in">echo</span>-request -j REJECT  </span><br><span class="line">$ iptables -A INPUT -p icmp --icmp-type 8 -j REJECT</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>protocol이(-p) icmp이고 icmp 의 type이 echo-request인 패킷이 오는(INPUT) 것을 거절하는(REJECT) 규칙을 추가(A)한다.  (외부에서의 ping을 거절하는 방법임 / echo-request대신에 8을 해도 됨 )</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp --dport 20:30 -j DROP</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>protocol이(-p) tcp이고 목적지 port(--dport)가 20번부터 30번까지인 패킷이 오는(INPUT) 것을 막는(DROP) 규칙을 추가(A)한다.</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state INVALID -j DROP</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>network상태가(state --state)가 INVALID인 패킷이 오는(INPUT) 것을 막는(DROP) 규칙을 추가(A)한다</p>
</blockquote>
<table>
<thead>
<tr>
<th>옵션</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>-m</td>
<td>match 여부로 패킷의 방향을 결정하는 옵션</td>
</tr>
<tr>
<td>state --state INVALID</td>
<td>패킷이 network연결되어 있는지 모르는 상태</td>
</tr>
<tr>
<td>state --state ESTABLISHED</td>
<td>패킷이 network 연결되어 있는 상태</td>
</tr>
<tr>
<td>state --state NEW</td>
<td>패킷이 network 새로 연결되어 있는 상태</td>
</tr>
<tr>
<td>state --state RELATED</td>
<td>패킷이 network새로 연결되어 있으나 이미 연결되어 있는 network와 연관성이 있는 상태</td>
</tr>
</tbody>
</table>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp --tcp-flags ACK ACK --dport 80 -m string --string <span class="string">"/default.ida?"</span> -j REJECT --reject-with tcp-reset</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>protocol이(-p) tcp이고 목적지가 80번 포트(--dport 80)로 오는(INPUT) 신호가 ACK이고 /default.ida?라는 문자열이 들어있는 패킷은 연결을 해제하고(tcp-reset) 거절하는(REJECT) 규칙을 추가(A)한다.</p>
</blockquote>
<ul>
<li>reject 옵션</li>
</ul>
<table>
<thead>
<tr>
<th>옵션</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>reject-with tcp-reset</td>
<td>RST 패킷을 돌려보내서 연결을 해제토록 함</td>
</tr>
<tr>
<td>reject-with icmp-net-unreachable</td>
<td>error 메시지를 돌려보냄</td>
</tr>
<tr>
<td>reject-with icmp-host-unreachable</td>
<td>error 메시지를 돌려보냄</td>
</tr>
<tr>
<td>reject-with icmp-port-unreachable</td>
<td>error 메시지를 돌려보냄</td>
</tr>
<tr>
<td>reject-with icmp-proto-unreachable</td>
<td>error 메시지를 돌려보냄</td>
</tr>
<tr>
<td>reject-with icmp-net-prohibitedor</td>
<td>error 메시지를 돌려보냄</td>
</tr>
<tr>
<td>reject-with icmp-host-prohibited</td>
<td>error 메시지를 돌려보냄</td>
</tr>
</tbody>
</table>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A input -i eth0 -s 10.0.0.0/8 -d 0/0 -j DENY</span><br><span class="line">$ iptables -A input -i eth0 -s 127.0.0.0/8 -d 0/0 -j DENY</span><br><span class="line">$ iptables -A input -i eth0 -s 172.16.0.0/16 -d 0/0 -j DENY</span><br><span class="line">$ iptables -A input -i eth0 -s 192.168.0.0/24 -d 0/0 -j DENY</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>외부에서 내부 네트워크 IP자격으로 접근하여 ip spoofing하는 것 방지</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>IP 주소를 할당 받은후 (POSTROUTING) NAT 테이블에 (-t nat) 서버밖으로 나가는 인터페이스(-o)가 ppp0인 모든 패킷들이 마스쿼레이드 되도록 (-j MASQUERADE) 규칙을 추가(-A) 한다.  * ppp0는 활성화된 외부 디바이스(External Interface)가 유동IP인 경우이며, 고정IP인 경우 ppp0대신에 eth0사용 (/sbin/ifconfig를 이용하여 활성화된 외부 디바이스 확인 가능)</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>유동(또는 고정) IP 한개인 서버를 통해 IP가 없는 PC에 인터넷 연결가능하게 함</p>
<p>PREROUTING : 서버안으로 들어오는 패킷에 해당되며, 들어오는 인터페이스(-i)만 선택 가능</p>
<p>POSTROUTING : 서버밖으로 나가는 패킷에 해당되면, 나가는 인터페이스(-o)만 선택 가능</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -t nat -A POSTROUTING -o eth0 -j SNAT --to 1.2.3.4</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>외부로 나가는 패킷의 출발지를 현재 내 PC의 IP주소인 200.200.200.200이 아닌 1.2.3.4로 변경</p>
</blockquote>
<p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -s 127.0.0.1 -p icmp -j DROP</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>127.0.0.1로부터의 모든 ICMP 패킷을 DROP한다.</p>
</blockquote>
<h2>참조</h2>
<p>http://xenostudy.tistory.com/245</p>

        </div>
        <footer class="article-footer">
            



    <a data-url="https://sacoku.github.io/2018/07/13/how-to-iptables/" data-id="cjjoy55bh000df42swcmgzdqy" class="article-share-link"><i class="fa fa-share"></i>공유하기</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>팔로우:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="https://twitter.com" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="https://www.facebook.com/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="https://plus.google.com/" target="_blank" rel="noopener">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
    
        <a href="/2018/07/13/infiniband-ipoib-layer2/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">오래된</strong>
        <p class="article-nav-title">인피니밴드 IPoIB로 Layer2 제어</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">최근 글</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/07/13/how-to-iptables/" class="thumbnail">
    
    
        <span style="background-image:url(https://www.famouslogos.us/images/linux-logo.jpg)" alt="Iptables 일반사항" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/DevOps/">DevOps</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/DevOps/Linux/">Linux</a></p>
                            <p class="item-title"><a href="/2018/07/13/how-to-iptables/" class="title">Iptables 일반사항</a></p>
                            <p class="item-date"><time datetime="2018-07-13T08:00:11.000Z" itemprop="datePublished">2018-07-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/07/13/infiniband-ipoib-layer2/" class="thumbnail">
    
    
        <span style="background-image:url(https://cdn.worldvectorlogo.com/logos/infiniband.svg)" alt="인피니밴드 IPoIB로 Layer2 제어" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Deveop/">Deveop</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/Deveop/Network/">Network</a></p>
                            <p class="item-title"><a href="/2018/07/13/infiniband-ipoib-layer2/" class="title">인피니밴드 IPoIB로 Layer2 제어</a></p>
                            <p class="item-date"><time datetime="2018-07-13T02:03:22.000Z" itemprop="datePublished">2018-07-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/07/13/alpine-linux-timezone/" class="thumbnail">
    
    
        <span style="background-image:url(https://subicura.com/assets/article_images/2017-01-19-docker-guide-for-beginners-1/docker-logo.png)" alt="Alpine Linux에서 Timezone 세팅" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/DevOps/">DevOps</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/DevOps/Linux/">Linux</a></p>
                            <p class="item-title"><a href="/2018/07/13/alpine-linux-timezone/" class="title">Alpine Linux에서 Timezone 세팅</a></p>
                            <p class="item-date"><time datetime="2018-07-13T01:57:10.000Z" itemprop="datePublished">2018-07-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/07/13/git-crlf/" class="thumbnail">
    
    
        <span style="background-image:url(https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Git-logo.svg/512px-Git-logo.svg.png)" alt="GIT CRLF 문제" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/DevOps/">DevOps</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/DevOps/Git/">Git</a></p>
                            <p class="item-title"><a href="/2018/07/13/git-crlf/" class="title">GIT CRLF 문제</a></p>
                            <p class="item-date"><time datetime="2018-07-12T23:42:05.000Z" itemprop="datePublished">2018-07-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/07/12/2018-07-12/" class="thumbnail">
    
    
        <span style="background-image:url(/images/sons.jpg)" alt="2018-07-12" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Blog/">Blog</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/Blog/2018/">2018</a></p>
                            <p class="item-title"><a href="/2018/07/12/2018-07-12/" class="title">2018-07-12</a></p>
                            <p class="item-date"><time datetime="2018-07-12T07:49:27.000Z" itemprop="datePublished">2018-07-12</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">카테고리</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Bigdata/">Bigdata</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Bigdata/Hadoop/">Hadoop</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Blog/">Blog</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Blog/2018/">2018</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/Git/">Git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/Linux/">Linux</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Deveop/">Deveop</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Deveop/Network/">Network</a><span class="category-list-count">1</span></li></ul></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">아카이브</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">7월 2018</a><span class="archive-list-count">8</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">태그</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Alpine-Linux/">Alpine Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bigdata/">Bigdata</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Infiniband/">Infiniband</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IpoIB/">IpoIB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sons/">Sons</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Timezone/">Timezone</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/">iptables</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">태그 클라우드</h3>
        <div class="widget tagcloud">
            <a href="/tags/Alpine-Linux/" style="font-size: 10px;">Alpine Linux</a> <a href="/tags/Bigdata/" style="font-size: 10px;">Bigdata</a> <a href="/tags/Docker/" style="font-size: 20px;">Docker</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/Hadoop/" style="font-size: 10px;">Hadoop</a> <a href="/tags/Infiniband/" style="font-size: 10px;">Infiniband</a> <a href="/tags/IpoIB/" style="font-size: 10px;">IpoIB</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Sons/" style="font-size: 10px;">Sons</a> <a href="/tags/Timezone/" style="font-size: 10px;">Timezone</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">링크</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2018 sacoku</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'sacou-github-io';
    
    
    var disqus_url = 'https://sacoku.github.io/2018/07/13/how-to-iptables/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
